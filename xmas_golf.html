<style>
body{ background:#000;}
</style>
<body>
  <script>
var con = console;
var width = 720,
height = 170,
time,
// floor = [],
pile = [],
snow = [];

function createCanvas(w,h) {
  var canvas = document.createElement("canvas");
  canvas.width = width;
  canvas.height = height;
  var ctx = canvas.getContext("2d");
  return {canvas:canvas,ctx:ctx}
}

var hit = createCanvas(width,height);

var stage = createCanvas(width,height);
document.body.appendChild(stage.canvas);
// var debug = document.createElement("div"); document.body.appendChild(debug); debug.innerHTML = "debug only"; debug.style.color = "white"; document.body.appendChild(hit.canvas);
var ctx = stage.ctx;

// for (var i = 0; i < width;i++) {
//   floor[i] = 0;
// }

function createFlake(index) {

  var brightness = (100 + ~~(Math.random() * 155)).toString(16);
  var colour = "#" + [brightness,brightness,brightness].join("");
  return {
    index: index,
    x: ~~(Math.random() * width),
    y: -10,
    moving: true,

    maxHits: ~~(Math.random() * 4),
    hits: 0,

    speed: Math.random() * 0.001,
    oscillation: Math.random() * 2,
    offset: Math.random() * 1e5,

    colour: colour,

    move: function() {
      this.y += 1;
      this.x += Math.sin(this.offset + this.speed * time) * this.oscillation;

      ctx.fillStyle = this.colour;
      ctx.fillRect(this.x, this.y, 1, 1);

      var intX = ~~this.x;
      var intY = ~~this.y;


      // if (this.y > height - floor[this.x] ) {

      var pixelIndex = (intY * width + intX) * 4;

      var seekingRed = this.hits % 2 == 0 ? 0 : 255;

      //con.log("imageData.data[pixelIndex]", seekingRed, imageData.data[pixelIndex]);

      if (intY > height ) {
        this.stop();
        return;
      }

      if (imageData.data[pixelIndex] == seekingRed ) { // we've hit black.

        this.hits++;

        if ( this.hits == this.maxHits ) {

          this.stop();

          hit.ctx.fillStyle = "rgba(" + seekingRed + "," + seekingRed + "," + seekingRed + ",1)";
          hit.ctx.fillRect(intX, intY - 1, 1, 1);

          // var spread = 10;
          // for(var i = -spread; i < spread; i++){
          //   floor[this.x + i] += ((spread + 1) - Math.abs(i)) * 0.05
          // }

          pile.push([intX, intY - 1, this.colour]);

        }

      }
    },
    stop: function () {
      this.moving = false;
      snow[index] = createFlake(index);
    },

  }
}

function drawCircle(x, y, rad){
  ctx.beginPath();
  ctx.arc(x, y, rad, 0, 2*Math.PI);
  ctx.fill();
}


function drawRect(x, y, width, height){
  ctx.strokeStyle="white";
  ctx.fillRect(x, y, width, height);
  ctx.stroke();
}

function drawStar(x, y, r, p, m) {
  ctx.save();
  ctx.beginPath();
  ctx.translate(x, y);
  ctx.moveTo(0,0-r);
  for (var i = 0; i < p; i++)
  {
    ctx.rotate(Math.PI / p);
    ctx.lineTo(0, 0 - (r*m));
    ctx.rotate(Math.PI / p);
    ctx.lineTo(0, 0 - r);
  }
  ctx.fill();
  ctx.restore();
}

function drawTree() {
  ctx.beginPath();
  ctx.moveTo(25,25);
  ctx.lineTo(105,25);
  ctx.lineTo(25,105);
  ctx.fill();
}

function drawTriangle(x, y, triangleWidth, triangleHeight, fillStyle){
  ctx.beginPath();
  ctx.moveTo(x, y);
  ctx.lineTo(x + triangleWidth / 2, y + triangleHeight);
  ctx.lineTo(x - triangleWidth / 2, y + triangleHeight);
  ctx.closePath();
  // ctx.fillStyle = fillStyle;
  ctx.fill();
}

function render(_time) {
  time = _time;
  imageData = hit.ctx.getImageData(0, 0, width, height);

  if (snow.length < 6000 && Math.random() > 0.1) {
    for (var i = 0; i < 30; i++) snow.push( createFlake(snow.length) );
  }

  ctx.clearRect(0,0,width,height);

  // for (var i = 0; i < width;i++) {
  //   ctx.fillRect(i, height, 1, -floor[i]);
  // }
  for (var i = 0, il = pile.length; i < il;i++) {
    ctx.fillStyle = pile[i][2];
    ctx.fillRect(pile[i][0], pile[i][1], 1, 1);
  }


  for (var i = 0; i < snow.length;i++) {
    if (snow[i].moving) snow[i].move();
  }

  /*
  drawCircle(100, 180, 40);
  drawCircle(100, 140, 30);
  drawCircle(100, 100, 25);

  ctx.fillStyle = "black";
  drawCircle(92, 92, 5);
  drawCircle(108, 92, 5);

  // drawHeart(108, 94)
  ctx.fillStyle = "white";
  drawRect(295, 170, 15, 30);
  ctx.fillStyle = "green";
  drawTriangle(300, 135, 140, 50);
  drawTriangle(300, 110, 115, 50);
  drawTriangle(300, 85, 90, 50);
  drawTriangle(300, 55, 60, 50);

  ctx.fillStyle = "yellow";
  drawStar(300, 50, 15, 5, 0.3)

  ctx.fillStyle = "white";

  */
  requestAnimationFrame(render);
}
var img = new Image();
img.onload = function() {
  hit.ctx.drawImage(img,0,0);
  hit.ctx.fillStyle = "#000";
  hit.ctx.fillRect(0,height,width,-10)
  render(0);
}
img.src = "at_logo.gif";

</script></body>
